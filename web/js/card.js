window.onload = async function () {
    const queryParams = new URLSearchParams(window.location.search);

    const username = queryParams.get("username") ?? "yorunoken";
    const mode = queryParams.get("mode") ?? "0";

    const baseUrl = window.location.href.split("/").slice(0, -1).join("/");
    const player = await fetch(`${baseUrl}/user?username=${username}&mode=${mode}`).then((res) => res.json());

    document.title = `User card for ${player.username} (${Number(player.pp_rank).toLocaleString()})`;
    const metaDescription = document.querySelector('meta[name="description"]');
    if (metaDescription) {
        metaDescription.setAttribute("content", `User card generated by yorunoken, for ${player.username}`);
    } else {
        const newMeta = document.createElement("meta");
        newMeta.setAttribute("name", "description");
        newMeta.setAttribute("content", `User card generated by yorunoken, for ${player.username}`);
        document.head.appendChild(newMeta);
    }
    console.log("updated shiii");

    document.getElementById("grade-ssh").textContent = player.count_rank_ssh;
    document.getElementById("grade-ss").textContent = player.count_rank_ss;
    document.getElementById("grade-sh").textContent = player.count_rank_sh;
    document.getElementById("grade-s").textContent = player.count_rank_s;
    document.getElementById("grade-a").textContent = player.count_rank_a;

    document.getElementById("username").textContent = player.username;
    document.getElementById("rank").textContent = `#${Number(player.pp_rank).toLocaleString()}`;
    document.getElementById("country-rank").textContent = `#${Number(player.pp_country_rank).toLocaleString()}`;
    document.getElementById("pp").textContent = `${Number(player.pp_raw).toFixed(2)}`;
    document.getElementById("accuracy").textContent = `${Number(player.accuracy).toFixed(2)}%`;
    document.getElementById("score").textContent = `${Number(player.ranked_score).toLocaleString()}`;
    document.getElementById("avatar").src = `https://a.ppy.sh/${player.user_id}`;

    const level = Number(player.level);
    const [, fraction] = level.toFixed(2).toString().split(".");
    document.getElementById("level").textContent = ` ${level.toFixed(2)}%`;

    document.getElementById("level-bar").style.background = `linear-gradient(to right, #5C99AB ${fraction}%, #2F393E ${fraction}%)`;
};
